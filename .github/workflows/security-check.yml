name: Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# CIãƒ†ã‚¹ãƒˆç”¨: ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: Check for sensitive data
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦å¤‰æ›´ã‚’æ¤œå‡º
        
      - name: Check for sensitive files
        run: |
          echo "ðŸ” Checking for sensitive files..."
          
          # æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
          SENSITIVE_FILES=(
            "*.env"
            "*.env.local"
            "*.env.*.local"
            "*.key"
            "*.pem"
            "*.p12"
            "*.pfx"
            "*.crt"
            "*.cer"
            "id_rsa"
            "id_dsa"
            "*.secret"
            "secrets/"
            "credentials/"
            "*.credentials"
          )
          
          FOUND_SENSITIVE=false
          for pattern in "${SENSITIVE_FILES[@]}"; do
            if find . -name "$pattern" -not -path "./.git/*" -not -path "./node_modules/*" | grep -q .; then
              echo "âŒ ERROR: Sensitive file pattern found: $pattern"
              find . -name "$pattern" -not -path "./.git/*" -not -path "./node_modules/*"
              FOUND_SENSITIVE=true
            fi
          done
          
          if [ "$FOUND_SENSITIVE" = true ]; then
            echo "::error::Sensitive files detected! Please remove them and update .gitignore"
            exit 1
          else
            echo "âœ… No sensitive files detected"
          fi
      
      - name: Check for hardcoded secrets
        run: |
          echo "ðŸ” Checking for hardcoded secrets..."
          
          # æ©Ÿå¯†æƒ…å ±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
          SECRET_PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api[_-]?key\s*=\s*['\"][^'\"]+['\"]"
            "secret[_-]?key\s*=\s*['\"][^'\"]+['\"]"
            "access[_-]?token\s*=\s*['\"][^'\"]+['\"]"
            "aws[_-]?access[_-]?key[_-]?id\s*=\s*['\"][^'\"]+['\"]"
            "aws[_-]?secret[_-]?access[_-]?key\s*=\s*['\"][^'\"]+['\"]"
            "private[_-]?key\s*=\s*['\"][^'\"]+['\"]"
            "BEGIN\s+(RSA\s+)?PRIVATE\s+KEY"
            "BEGIN\s+EC\s+PRIVATE\s+KEY"
            "xox[baprs]-[0-9a-zA-Z-]{10,48}"  # Slack token
            "ghp_[0-9a-zA-Z]{36}"  # GitHub personal access token
            "gho_[0-9a-zA-Z]{36}"  # GitHub OAuth token
            "ghu_[0-9a-zA-Z]{36}"  # GitHub user-to-server token
            "ghs_[0-9a-zA-Z]{36}"  # GitHub server-to-server token
            "ghr_[0-9a-zA-Z]{36}"  # GitHub refresh token
            "AKIA[0-9A-Z]{16}"  # AWS access key ID
            "AIza[0-9A-Za-z\\-_]{35}"  # Google API key
            "ya29\\.[0-9A-Za-z\\-_]+"  # Google OAuth token
            "sk_live_[0-9a-zA-Z]{24,32}"  # Stripe live key
            "sk_test_[0-9a-zA-Z]{24,32}"  # Stripe test key
            "pk_live_[0-9a-zA-Z]{24,32}"  # Stripe public key
            "pk_test_[0-9a-zA-Z]{24,32}"  # Stripe public test key
          )
          
          FOUND_SECRETS=false
          
          # HTMLã€JavaScriptã€JSONã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          for file in $(find . -type f \( -name "*.html" -o -name "*.js" -o -name "*.json" -o -name "*.yml" -o -name "*.yaml" -o -name "*.env*" -o -name "*.config.*" \) -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./.github/*"); do
            for pattern in "${SECRET_PATTERNS[@]}"; do
              if grep -iE "$pattern" "$file" > /dev/null 2>&1; then
                echo "âŒ WARNING: Potential secret found in $file"
                echo "   Pattern: $pattern"
                grep -iE "$pattern" "$file" | head -3 | sed 's/^/   /'
                FOUND_SECRETS=true
              fi
            done
          done
          
          if [ "$FOUND_SECRETS" = true ]; then
            echo "::warning::Potential hardcoded secrets detected! Please review and use environment variables or secrets management."
            echo "âš ï¸  This may be a false positive. Please review the findings."
          else
            echo "âœ… No hardcoded secrets detected"
          fi
      
      - name: Check .gitignore for sensitive patterns
        run: |
          echo "ðŸ” Checking .gitignore coverage..."
          
          if [ ! -f .gitignore ]; then
            echo "::error::.gitignore file not found!"
            exit 1
          fi
          
          # .gitignoreã«å«ã¾ã‚Œã‚‹ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
          REQUIRED_PATTERNS=(
            ".env"
            "*.key"
            "*.pem"
            "*.secret"
            "node_modules"
          )
          
          MISSING_PATTERNS=()
          for pattern in "${REQUIRED_PATTERNS[@]}"; do
            if ! grep -qE "(^|/)$pattern" .gitignore; then
              MISSING_PATTERNS+=("$pattern")
            fi
          done
          
          if [ ${#MISSING_PATTERNS[@]} -gt 0 ]; then
            echo "âš ï¸  WARNING: .gitignore may be missing some recommended patterns:"
            printf '   - %s\n' "${MISSING_PATTERNS[@]}"
            echo "::warning::Consider adding these patterns to .gitignore"
          else
            echo "âœ… .gitignore covers recommended patterns"
          fi
      
      - name: Check for large files
        run: |
          echo "ðŸ” Checking for large files..."
          
          # 10MBä»¥ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          LARGE_FILES=$(find . -type f -size +10M -not -path "./.git/*" -not -path "./node_modules/*")
          
          if [ -n "$LARGE_FILES" ]; then
            echo "âš ï¸  WARNING: Large files detected (>10MB):"
            echo "$LARGE_FILES" | while read file; do
              size=$(du -h "$file" | cut -f1)
              echo "   $file ($size)"
            done
            echo "::warning::Large files may slow down the repository. Consider using Git LFS or external storage."
          else
            echo "âœ… No unusually large files detected"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## Security Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security scan completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checks performed:" >> $GITHUB_STEP_SUMMARY
          echo "- Sensitive files detection" >> $GITHUB_STEP_SUMMARY
          echo "- Hardcoded secrets detection" >> $GITHUB_STEP_SUMMARY
          echo "- .gitignore coverage check" >> $GITHUB_STEP_SUMMARY
          echo "- Large files check" >> $GITHUB_STEP_SUMMARY

